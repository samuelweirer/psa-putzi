# Handover: Auth Service to API Gateway Integration

**From:** @Senior-2 (Auth Backend Developer)
**To:** @Senior-4 (Integration Specialist - API Gateway)
**Date:** 2025-11-05 08:30 UTC
**Purpose:** Enable API Gateway development with auth service integration

---

## üéØ Overview

The authentication service is **production-ready** and provides all the JWT validation and RBAC capabilities needed for the API Gateway. This handover provides everything you need to integrate auth into the gateway.

**Your Mission:** Build an API Gateway that:
- Routes requests to all microservices (auth on 3001, future services)
- Validates JWT tokens from auth service
- Enforces role-based access control (RBAC)
- Provides centralized rate limiting, logging, and error handling

---

## ‚úÖ Auth Service Status

### Operational
- **Service:** Running on PM2 (port 3001)
- **PID:** 55270
- **Uptime:** 10+ hours stable
- **Health:** http://localhost:3001/health
- **Docs:** http://localhost:3001/api-docs

### Completed Features
- ‚úÖ JWT token generation (RS256)
- ‚úÖ JWT token validation (middleware ready)
- ‚úÖ Refresh token rotation
- ‚úÖ RBAC with 23 roles
- ‚úÖ MFA support (TOTP)
- ‚úÖ OAuth2 (Google, Microsoft)
- ‚úÖ Password management
- ‚úÖ User profile management
- ‚úÖ Rate limiting (Redis-based)

### Quality Metrics
- **Test Coverage:** 80.5%
- **Tests Passing:** 175/175 (145 unit + 30 integration)
- **API Endpoints:** 16 (all documented)
- **Documentation:** Complete (Swagger + handover)

---

## üîê JWT Integration Guide

### 1. JWT Token Format

**Access Token** (expires in 15 minutes):
```json
{
  "sub": "user-id-uuid",
  "email": "user@example.com",
  "role": "customer_user",
  "permissions": {},
  "iat": 1699123456,
  "exp": 1699124356,
  "jti": "unique-token-id"
}
```

**Key Points:**
- **Algorithm:** RS256 (asymmetric)
- **Issuer:** psa-auth-service
- **Audience:** psa-platform
- **JTI:** Unique ID for token tracking/revocation

### 2. JWT Validation Middleware (Ready to Use!)

**Location:** `services/auth-service/src/middleware/auth.middleware.ts`

**Key Functions:**
```typescript
// Validate JWT and attach user to request
export const authenticateJWT = async (req, res, next) => {
  // Extracts Bearer token
  // Verifies signature with public key
  // Validates expiration
  // Attaches user to req.user
}

// Check if user has required role
export const requireRole = (allowedRoles: UserRole[]) => {
  return (req, res, next) => {
    // Checks if req.user.role is in allowedRoles
  }
}

// Check if user has specific permission
export const requirePermission = (permission: string) => {
  return (req, res, next) => {
    // Checks if req.user.permissions includes permission
  }
}
```

**Usage in Gateway:**
```typescript
// In your gateway routes
import { authenticateJWT, requireRole } from '../auth-middleware';

// Public route (no auth)
gateway.get('/health', (req, res) => { ... });

// Protected route (any authenticated user)
gateway.get('/api/v1/users/me',
  authenticateJWT,
  (req, res) => {
    // req.user is available here
  }
);

// Role-protected route
gateway.post('/api/v1/customers',
  authenticateJWT,
  requireRole(['system_admin', 'tenant_admin']),
  (req, res) => { ... }
);
```

### 3. JWT Secrets/Keys

**Location:** Auth service uses environment variables

**For Gateway (JWT Verification):**
```bash
# In gateway .env file
JWT_SECRET=your-secret-key-here  # Same as auth service
JWT_PUBLIC_KEY=<public-key-pem>  # For RS256 verification (if using asymmetric)

# OR if using symmetric (HS256)
JWT_SECRET=your-secret-key-here  # Same secret as auth service
```

**How to Get Keys:**
```bash
# Check auth service .env
cat services/auth-service/.env | grep JWT_SECRET

# Copy the same secret to gateway .env
# This allows gateway to verify tokens generated by auth service
```

---

## üé≠ RBAC System Integration

### Role Hierarchy (23 Roles)

**System Admins:**
```typescript
'system_admin'      // Full system access
'tenant_admin'      // Tenant management
'security_admin'    // Security operations
'service_manager'   // Service management
```

**Software Developers:**
```typescript
'software_developer_lead'    // Team lead
'software_developer_senior'  // Senior dev
'software_developer'         // Mid-level
'software_developer_junior'  // Junior
```

**Support Technicians:**
```typescript
'technician_lead'    // Support team lead
'technician_senior'  // Senior tech
'technician'         // Mid-level tech
'technician_junior'  // Junior tech
```

**Legacy Tiers (Deprecated):**
```typescript
'technician_l3'  // Level 3 support
'technician_l2'  // Level 2 support
'technician_l1'  // Level 1 support
```

**Other Internal:**
```typescript
'account_manager'   // Account management
'project_manager'   // Project management
'billing_manager'   // Billing operations
```

**Customer Roles:**
```typescript
'customer_admin'       // Customer organization admin
'customer_technician'  // Customer IT staff
'customer_user'        // End user
```

### RBAC Middleware (Ready to Use)

**Location:** `services/auth-service/src/middleware/rbac.middleware.ts`

**Key Functions:**
```typescript
// Check role hierarchy
export const checkRoleHierarchy = (userRole: UserRole, requiredRole: UserRole): boolean => {
  // Returns true if userRole has access (equal or higher in hierarchy)
}

// Common permission checks
export const canManageUsers = (role: UserRole): boolean => { ... }
export const canManageCustomers = (role: UserRole): boolean => { ... }
export const canViewBilling = (role: UserRole): boolean => { ... }
export const canManageTickets = (role: UserRole): boolean => { ... }
```

**Usage in Gateway Routes:**
```typescript
// System admin only
gateway.post('/api/v1/admin/*',
  authenticateJWT,
  requireRole(['system_admin']),
  proxyToService
);

// Technicians and above
gateway.get('/api/v1/tickets',
  authenticateJWT,
  requireRole(['technician', 'technician_senior', 'technician_lead']),
  proxyToService
);

// Customers can access their own data
gateway.get('/api/v1/customers/me',
  authenticateJWT,
  // All roles allowed (checked in downstream service)
  proxyToService
);
```

---

## üîÑ Service Integration Points

### 1. Auth Service Endpoints (Port 3001)

**For Gateway Use:**
```
POST /api/v1/auth/register      - User registration
POST /api/v1/auth/login         - User login (returns tokens)
POST /api/v1/auth/refresh       - Token refresh
POST /api/v1/auth/logout        - Token revocation
GET  /api/v1/auth/me            - Current user profile
```

**Gateway Should Proxy These:**
- All `/api/v1/auth/*` requests should be forwarded to auth service on port 3001
- Gateway adds: rate limiting, logging, CORS
- Gateway does NOT validate JWT for login/register (those are public endpoints)

### 2. Token Flow

```
Client Request (with JWT)
      ‚Üì
API Gateway (port 3000)
      ‚Üì
1. Extract Bearer token
2. Validate JWT (using JWT_SECRET)
3. Check RBAC permissions
4. Add user context to request
      ‚Üì
Downstream Service (auth:3001, future: crm:3002, etc)
      ‚Üì
Service trusts gateway (already validated)
Service uses req.user.sub, req.user.role
      ‚Üì
Response back through gateway
```

### 3. Request Headers to Forward

**Gateway Should Add:**
```
X-User-ID: {user.sub}           // User UUID
X-User-Email: {user.email}      // User email
X-User-Role: {user.role}        // User role
X-Request-ID: {uuid}            // Request tracking
X-Gateway-Time: {timestamp}     // Gateway timestamp
```

**Gateway Should Preserve:**
```
Authorization: Bearer {token}   // Original token
Content-Type: {original}
Accept: {original}
User-Agent: {original}
```

---

## üìä Rate Limiting Strategy

### Auth Service Rate Limits (Already Implemented)

**Global Rate Limit:**
- 100 requests per 15 minutes per IP
- Implemented with Redis + express-rate-limit

**Auth-Specific Limits:**
- Login: 5 attempts per 15 minutes per IP
- Register: 3 attempts per 15 minutes per IP
- Password reset: 3 attempts per hour per email

### Gateway Should Add

**API Rate Limits (Recommendation):**
```typescript
// Global API limit
100 requests per minute per user (authenticated)
20 requests per minute per IP (unauthenticated)

// Endpoint-specific limits
POST endpoints: 30 per minute per user
GET endpoints: 100 per minute per user
Admin endpoints: 50 per minute per admin
```

**Implementation:**
- Use Redis for distributed rate limiting
- Key format: `ratelimit:${userId}:${endpoint}`
- Return 429 Too Many Requests with Retry-After header

---

## üîç Logging & Monitoring

### What Auth Service Logs

**Using Winston:**
```typescript
// Info level
logger.info('User logged in', { userId, email, ip });

// Error level
logger.error('Login failed', { email, error, ip });

// Audit events
logger.info('Password changed', { userId, ip });
```

**Log Location:**
- `/tmp/auth-service.log` (all logs)
- `/tmp/auth-service-error.log` (errors only)

### Gateway Should Log

**Request Logging:**
```typescript
{
  requestId: uuid,
  method: 'POST',
  path: '/api/v1/customers',
  userId: 'user-uuid',
  userRole: 'customer_admin',
  ip: '10.0.0.1',
  userAgent: 'Mozilla/5.0...',
  duration: 234,  // ms
  statusCode: 200,
  timestamp: '2025-11-05T08:30:00Z'
}
```

**Error Logging:**
```typescript
{
  requestId: uuid,
  error: 'Downstream service timeout',
  service: 'auth-service',
  endpoint: '/api/v1/auth/login',
  statusCode: 504,
  userId: 'user-uuid',
  timestamp: '2025-11-05T08:30:00Z'
}
```

---

## üö® Error Handling

### Auth Service Error Responses

**Standard Format:**
```json
{
  "error": "AUTHENTICATION_FAILED",
  "message": "Invalid email or password",
  "code": "AUTH_001",
  "details": null
}
```

**Common Error Codes:**
```
AUTHENTICATION_FAILED - Invalid credentials
UNAUTHORIZED - No/invalid token
FORBIDDEN - Insufficient permissions
VALIDATION_ERROR - Invalid input
RATE_LIMIT_EXCEEDED - Too many requests
INTERNAL_SERVER_ERROR - Unexpected error
```

### Gateway Should Handle

**Token Errors:**
```typescript
// Expired token ‚Üí 401 Unauthorized
if (tokenExpired) {
  return res.status(401).json({
    error: 'TOKEN_EXPIRED',
    message: 'Access token expired, please refresh',
    code: 'GATEWAY_001'
  });
}

// Invalid token ‚Üí 401 Unauthorized
if (invalidSignature) {
  return res.status(401).json({
    error: 'INVALID_TOKEN',
    message: 'Token signature invalid',
    code: 'GATEWAY_002'
  });
}

// Missing token on protected route ‚Üí 401
if (!token && routeRequiresAuth) {
  return res.status(401).json({
    error: 'AUTHENTICATION_REQUIRED',
    message: 'Access token required',
    code: 'GATEWAY_003'
  });
}
```

**Service Errors:**
```typescript
// Downstream service down ‚Üí 503 Service Unavailable
// Downstream timeout ‚Üí 504 Gateway Timeout
// Downstream 5xx ‚Üí 502 Bad Gateway
```

---

## üèóÔ∏è Gateway Architecture

### Recommended Structure

```
services/api-gateway/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.ts         // JWT validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rbac.middleware.ts         // Role checking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rate-limit.middleware.ts   // Rate limiting
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.middleware.ts       // Request logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error.middleware.ts        // Error handling
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cors.middleware.ts         // CORS handling
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.ts             // Proxy to auth service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.routes.ts           // Gateway health
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proxy.routes.ts            // Dynamic routing
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ proxy.service.ts           // HTTP proxy logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ circuit-breaker.service.ts // Resilience
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service-discovery.ts       // Service registry
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt.util.ts                // JWT helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.ts                  // Winston config
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.ts                  // Configuration
‚îÇ   ‚îú‚îÄ‚îÄ app.ts                         // Express app
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                       // Entry point
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îî‚îÄ‚îÄ integration/
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ ecosystem.config.js                // PM2 config
```

### Service Registry (Simple Start)

```typescript
// services/api-gateway/src/config/services.ts
export const serviceRegistry = {
  auth: {
    name: 'auth-service',
    url: 'http://localhost:3001',
    healthCheck: '/health',
    timeout: 5000,
    retries: 3
  },
  // Future services
  crm: {
    name: 'crm-service',
    url: 'http://localhost:3002',
    healthCheck: '/health',
    timeout: 5000,
    retries: 3
  },
  tickets: {
    name: 'tickets-service',
    url: 'http://localhost:3003',
    healthCheck: '/health',
    timeout: 5000,
    retries: 3
  }
};
```

---

## üîå Integration Example

### Complete Gateway Route Example

```typescript
import express from 'express';
import { createProxyMiddleware } from 'http-proxy-middleware';
import { authenticateJWT, requireRole } from './middleware/auth.middleware';
import { apiRateLimit } from './middleware/rate-limit.middleware';
import { requestLogger } from './middleware/logger.middleware';

const app = express();

// Global middleware
app.use(express.json());
app.use(requestLogger);
app.use(apiRateLimit);

// Public routes (no auth)
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', service: 'api-gateway' });
});

// Proxy to auth service (mixed public/protected)
app.use('/api/v1/auth', createProxyMiddleware({
  target: 'http://localhost:3001',
  changeOrigin: true,
  onProxyReq: (proxyReq, req) => {
    // Add gateway headers
    proxyReq.setHeader('X-Gateway', 'psa-api-gateway');
    proxyReq.setHeader('X-Request-ID', req.id);

    // Add user context if authenticated
    if (req.user) {
      proxyReq.setHeader('X-User-ID', req.user.sub);
      proxyReq.setHeader('X-User-Role', req.user.role);
    }
  }
}));

// Protected routes (require auth)
app.use('/api/v1/customers',
  authenticateJWT,
  requireRole(['system_admin', 'tenant_admin', 'customer_admin']),
  createProxyMiddleware({
    target: 'http://localhost:3002',  // Future CRM service
    changeOrigin: true
  })
);

// Admin-only routes
app.use('/api/v1/admin',
  authenticateJWT,
  requireRole(['system_admin']),
  createProxyMiddleware({
    target: 'http://localhost:3004',  // Future admin service
    changeOrigin: true
  })
);

app.listen(3000, () => {
  console.log('API Gateway running on port 3000');
});
```

---

## üìã Pre-Launch Checklist

### Environment Setup
- [ ] Copy auth service JWT_SECRET to gateway .env
- [ ] Configure Redis connection (for rate limiting)
- [ ] Set up service registry with auth service URL
- [ ] Configure CORS allowed origins
- [ ] Set up Winston logger

### Code Setup
- [ ] Install dependencies (express, http-proxy-middleware, jsonwebtoken)
- [ ] Copy auth middleware from auth service
- [ ] Copy RBAC middleware from auth service
- [ ] Implement proxy routing
- [ ] Add request logging
- [ ] Add error handling

### Testing
- [ ] Test JWT validation with real tokens from auth service
- [ ] Test RBAC with different role levels
- [ ] Test proxy to auth service endpoints
- [ ] Test rate limiting
- [ ] Test error scenarios (invalid token, service down)
- [ ] Test CORS configuration

### Documentation
- [ ] API endpoint documentation
- [ ] Service discovery documentation
- [ ] Deployment guide
- [ ] Monitoring guide

---

## üéØ Success Criteria

**Gateway is ready when:**
- ‚úÖ Routes requests to auth service correctly
- ‚úÖ Validates JWT tokens (using auth service secret)
- ‚úÖ Enforces RBAC correctly (all 23 roles)
- ‚úÖ Implements rate limiting
- ‚úÖ Logs all requests
- ‚úÖ Handles errors gracefully
- ‚úÖ Returns proper HTTP status codes
- ‚úÖ CORS configured correctly
- ‚úÖ Health check endpoint works
- ‚úÖ Deployed on PM2 (port 3000)
- ‚úÖ Integration tests pass
- ‚úÖ Documentation complete

---

## üìö Reference Materials

### Auth Service Documentation
- **Swagger UI:** http://localhost:3001/api-docs
- **Source Code:** `services/auth-service/src/`
- **Handover:** `.subagents/handovers/04-auth-backend-ready-for-frontend.md`
- **Implementation Guide:** `implementation/02-MODULE-Auth.md`

### Gateway Module Guide
- **Implementation:** `implementation/03-MODULE-API-Gateway.md`
- **BDUF Architecture:** `BDUF/BDUF-Chapter4.md` (API Design)
- **BDUF Security:** `BDUF/BDUF-Chapter5.md` (Security Architecture)

### Code References
- **Auth Middleware:** `services/auth-service/src/middleware/auth.middleware.ts:12-89`
- **RBAC Middleware:** `services/auth-service/src/middleware/rbac.middleware.ts:8-156`
- **JWT Service:** `services/auth-service/src/services/jwt.service.ts:18-125`
- **Types:** `services/auth-service/src/types/index.ts:95-102` (JWTPayload)

---

## ü§ù Support & Communication

### Daily Sync
- Update `.subagents/status/gateway-agent-YYYY-MM-DD.md` daily
- Check `.subagents/issues/` for blockers
- Review frontend agent's status (parallel work)

### Questions?
- **Auth Integration:** Ask @Senior-2 (me)
- **Architecture:** Review BDUF or ask @Main-Agent (PM)
- **Frontend Coordination:** Check with @Junior-5

### Blockers
- Create issue: `.subagents/issues/YYYY-MM-DD-description.md`
- @mention relevant agents
- Response SLA: < 2 hours for senior-to-senior

---

## üéâ You're Ready!

The auth service is stable, well-tested, and production-ready. You have everything you need to build a robust API Gateway that integrates seamlessly with authentication and authorization.

**Key Takeaway:** The hard auth work is done. Your gateway just needs to validate tokens and forward requests. Keep it simple, keep it fast.

**Good luck, @Senior-4!** üöÄ

---

**Handover Date:** 2025-11-05 08:30 UTC
**Handed Over By:** @Senior-2 (Auth Backend Developer)
**Received By:** @Senior-4 (Integration Specialist - API Gateway)
**Auth Service Status:** 95% Complete, Production-Ready
**Gateway Status:** Ready to Start

---

**Next Handover:** Gateway ‚Üí CRM (when gateway is 80%+ complete)
